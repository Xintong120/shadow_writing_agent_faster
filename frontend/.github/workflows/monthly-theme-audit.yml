# GitHub Actions - æœˆåº¦ä¸»é¢˜ä¸€è‡´æ€§å®¡è®¡
# æ¯æœˆè‡ªåŠ¨æ‰§è¡Œä¸»é¢˜ä¸€è‡´æ€§å®¡è®¡å¹¶ç”ŸæˆæŠ¥å‘Š

name: Monthly Theme Audit

on:
  schedule:
    # æ¯æœˆ1å·å‡Œæ™¨2ç‚¹æ‰§è¡Œ (UTCæ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´10ç‚¹)
    - cron: '0 2 1 * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  theme-audit:
    name: Theme Consistency Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Run theme audit
      id: audit
      run: |
        cd frontend
        npm run audit:theme:ci || echo "audit_failed=true" >> $GITHUB_OUTPUT
      continue-on-error: true
    
    - name: Upload audit reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: theme-audit-reports-${{ github.run_number }}
        path: frontend/audit-reports/
        retention-days: 90
    
    - name: Read audit summary
      id: summary
      if: always()
      run: |
        cd frontend
        if [ -f audit-reports/latest-audit.json ]; then
          TOTAL=$(jq '.summary.totalViolations' audit-reports/latest-audit.json)
          CRITICAL=$(jq '.summary.criticalViolations' audit-reports/latest-audit.json)
          WARNING=$(jq '.summary.warningViolations' audit-reports/latest-audit.json)
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "warning=$WARNING" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Issue for violations
      if: steps.summary.outputs.total > 0
      uses: actions/github-script@v7
      with:
        script: |
          const total = '${{ steps.summary.outputs.total }}';
          const critical = '${{ steps.summary.outputs.critical }}';
          const warning = '${{ steps.summary.outputs.warning }}';
          
          const body = `## ğŸ” æœˆåº¦ä¸»é¢˜ä¸€è‡´æ€§å®¡è®¡æŠ¥å‘Š
          
          **å®¡è®¡æ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
          **å®¡è®¡ç»“æœ**: âš ï¸ å‘ç°è¿è§„
          
          ### ğŸ“Š ç»Ÿè®¡æ‘˜è¦
          
          - **æ€»è¿è§„æ•°**: ${total}
          - **ä¸¥é‡è¿è§„**: ${critical} ğŸ”´
          - **è­¦å‘Šè¿è§„**: ${warning} âš ï¸
          
          ### ğŸ“ è¯¦ç»†æŠ¥å‘Š
          
          è¯¦ç»†çš„å®¡è®¡æŠ¥å‘Šå·²ä¸Šä¼ åˆ° [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### ğŸ’¡ å»ºè®®è¡ŒåŠ¨
          
          1. **ç«‹å³å¤„ç†**: ä¿®å¤æ‰€æœ‰ä¸¥é‡è¿è§„ï¼ˆç¡¬ç¼–ç é¢œè‰²ï¼‰
          2. **è®¡åˆ’å¤„ç†**: é€æ­¥ä¿®å¤è­¦å‘Šè¿è§„ï¼ˆç¡¬ç¼–ç é—´è·ã€å­—ä½“ã€åœ†è§’ï¼‰
          3. **é¢„é˜²æªæ–½**: ç¡®ä¿ESLintè§„åˆ™å·²å¯ç”¨ï¼Œé˜²æ­¢æ–°çš„è¿è§„
          
          ### ğŸ”— ç›¸å…³èµ„æº
          
          - [ä¸»é¢˜ä½¿ç”¨æŒ‡å—](../THEME_USAGE_GUIDE.md)
          - [ä¸»é¢˜è¿ç§»æŒ‡å—](../THEME_MIGRATION_GUIDE.md)
          - [ESLinté…ç½®](.eslintrc.cjs)
          `;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: \`[ä¸»é¢˜å®¡è®¡] \${new Date().toISOString().split('T')[0]} - å‘ç° \${total} ä¸ªè¿è§„\`,
            body: body,
            labels: ['theme-consistency', 'audit', 'technical-debt']
          });
    
    - name: Comment on success
      if: steps.summary.outputs.total == 0
      uses: actions/github-script@v7
      with:
        script: |
          console.log('âœ… ä¸»é¢˜ä¸€è‡´æ€§å®¡è®¡é€šè¿‡ï¼Œæœªå‘ç°è¿è§„');
    
    - name: Generate trend data
      if: always()
      run: |
        cd frontend
        mkdir -p audit-reports/history
        DATE=$(date +%Y-%m-%d)
        cp audit-reports/latest-audit.json audit-reports/history/audit-$DATE.json
    
    - name: Commit audit history
      if: always()
      run: |
        cd frontend
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add audit-reports/history/
        git diff --quiet && git diff --staged --quiet || git commit -m "chore: add theme audit history for $(date +%Y-%m-%d)"
        git push
      continue-on-error: true
